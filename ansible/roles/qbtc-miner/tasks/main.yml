---
# 1. Install Docker
- name: Install Docker
  apt:
    name: docker.io
    state: present
    update_cache: true
  become: true

# 2. Ensure Docker service is running and enabled
- name: Start and enable Docker service
  systemd:
    name: docker
    state: started
    enabled: true
  become: true

# 3. Add user to docker group
- name: Add {{ qbtc_user }} to docker group
  user:
    name: "{{ qbtc_user }}"
    groups: docker
    append: true
  become: true

# 4. Create data directory
- name: Create data directory
  file:
    path: "{{ qbtc_datadir }}"
    state: directory
    owner: "{{ qbtc_user }}"
    group: "{{ qbtc_user }}"
    mode: "0755"
  become: true

# 5. Pull latest image
- name: Pull QBTC Docker image
  command: docker pull {{ qbtc_image }}
  changed_when: true

# 6. Stop and remove existing container
- name: Stop existing container
  command: docker stop {{ qbtc_node_name }}
  failed_when: false
  changed_when: true

- name: Remove existing container
  command: docker rm {{ qbtc_node_name }}
  failed_when: false
  changed_when: true

# 7. Run container
- name: Run QBTC node container
  command: >-
    docker run -d
    --name {{ qbtc_node_name }}
    --restart unless-stopped
    -p {{ qbtc_rpc_port }}:3001
    -p {{ qbtc_p2p_port }}:6001
    -v {{ qbtc_datadir }}:/data
    {{ qbtc_image }}
    --mine --full --datadir /data
    {% if qbtc_message %}--message "{{ qbtc_message }}"{% endif %}
  changed_when: true

# 8. Wait for node to come up (snapshot download + genesis can take ~10 min)
- name: Wait for QBTC node RPC to respond
  uri:
    url: "http://127.0.0.1:{{ qbtc_rpc_port }}/api/v1/status"
    method: GET
    return_content: true
  register: node_status
  until: node_status.status == 200
  retries: 60
  delay: 10
  changed_when: false

# 9. Display status
- name: Display node status
  debug:
    var: node_status.json
